<lib-extension-point extensionId="external-instance-hint"></lib-extension-point>

<div fxLayout="column" fxLayoutGap="10px">
  <lib-extension-point
    extensionId="lms-course-room-list"
    [extensionData]="{ userId: auth().userId, excludeRoomIds: roomIds }"
  ></lib-extension-point>
  <div>
    <mat-card class="account-memberships">
      <div
        fxFill
        fxLayout="row wrap"
        fxLayoutAlign="space-between center"
        class="header-container"
      >
        <div fxLayout="row" fxLayoutGap="10px" class="button-container">
          <button
            mat-raised-button
            color="primary"
            class="desktop-buttons"
            (click)="openCreateRoomDialog()"
            id="create-room-button"
            appHotkey="2"
            [appHotkeyTitle]="'home-page.create-room' | transloco"
          >
            <mat-icon class="add-icon">add</mat-icon>
            <span>{{ 'home-page.create-room' | transloco }}</span>
          </button>
        </div>
        <div class="search-container full-width-container">
          <mat-icon matPrefix class="search-icon">search</mat-icon>
          <input
            [disabled]="noRooms()"
            matInput
            class="search-input full-width-search"
            #search
            placeholder="{{ 'room-list.filter-message' | transloco }}"
            aria-labelledby="filter-rooms"
          />
        </div>
      </div>
      <button
        mat-fab
        color="primary"
        class="mobile-add mobile-buttons"
        aria-labelledby="add-room"
        (click)="openCreateRoomDialog()"
      >
        <mat-icon class="add-icon">add</mat-icon>
      </button>
      @if (isLoading()) {
        <app-loading-indicator></app-loading-indicator>
      } @else {
        <div
          fxFill
          fxLayout="column"
          fxLayoutAlign="center center"
          tabindex="0"
          id="room-list"
          [ngClass]="{ 'visually-hidden': !noRooms() }"
        >
          <h3 class="hint">
            {{
              noRooms()
                ? ('room-list.no-rooms' | transloco)
                : ('room-list.a11y-list-summary'
                  | transloco: { count: rooms().length })
            }}
          </h3>
        </div>
        @if (search.value && rooms().length === 0 && !noRooms()) {
          <div fxLayout="column" fxLayoutAlign="center center">
            <h3 class="hint">{{ 'room-list.no-rooms-found' | transloco }}</h3>
            <button
              mat-stroked-button
              color="primary"
              class="alt-button"
              routerLink=""
            >
              {{ 'room-list.join-room' | transloco }}
            </button>
          </div>
        }
        @if (errors()) {
          <p>Error</p>
        } @else if (rooms().length > 0) {
          <mat-action-list>
            @for (roomWithRole of rooms(); track roomWithRole; let i = $index) {
              <button
                disableRipple
                mat-list-item
                (click)="
                  setCurrentRoom(roomWithRole.room.shortId, roomWithRole.role)
                "
                class="bottom-border full-width-list-item"
              >
                <div fxLayout="row" fxFill class="outer">
                  <div
                    fxLayout="row"
                    fxLayoutAlign="space-between center"
                    fxLayoutGap="0.5em"
                    class="inner container"
                    attr.aria-label="{{
                      'room-list.a11y-join-room'
                        | transloco
                          : {
                              room: roomWithRole.room.name,
                              id: roomWithRole.room.shortId,
                              role: roles.get(roomWithRole.role),
                            }
                    }}"
                  >
                    <app-text-overflow-clip
                      class="ellipsis"
                      [text]="roomWithRole.room.name"
                    ></app-text-overflow-clip>
                    <div
                      fxLayout="row"
                      fxLayoutAlign="center center"
                      fxLayoutGap="1em"
                    >
                      @if (
                        isRoomActive(roomWithRole.stats?.roomUserCount ?? 0)
                      ) {
                        <div
                          fxLayoutAlign="center"
                          class="active-label primary"
                          [matTooltip]="
                            'room-list.active-info'
                              | transloco
                                : {
                                    userCount:
                                      roomWithRole.stats?.roomUserCount ?? 0,
                                  }
                          "
                        >
                          <span>{{ 'room-list.active' | transloco }}</span>
                        </div>
                      }
                      @if (roomWithRole.stats?.ackCommentCount ?? 0) {
                        <app-list-badge
                          [count]="roomWithRole.stats?.ackCommentCount ?? 0"
                        ></app-list-badge>
                      }
                      <p class="short-id">
                        {{ roomWithRole.room.shortId | splitShortId }}
                      </p>
                      <div>
                        @switch (roomWithRole.role) {
                          @case (RoomRole.Owner) {
                            <mat-icon
                              mat-list-icon
                              matTooltip="{{
                                'room-list.creator-role' | transloco
                              }}"
                              title="{{ 'room-list.creator-role' | transloco }}"
                            >
                              record_voice_over
                            </mat-icon>
                          }
                          @case (RoomRole.Participant) {
                            <mat-icon
                              mat-list-icon
                              matTooltip="{{
                                'room-list.participant-role' | transloco
                              }}"
                              title="{{
                                'room-list.participant-role' | transloco
                              }}"
                            >
                              people
                            </mat-icon>
                          }
                          @case (RoomRole.Moderator) {
                            <mat-icon
                              mat-list-icon
                              matTooltip="{{
                                'room-list.executive-moderator-role' | transloco
                              }}"
                              title="{{
                                'room-list.executive-moderator-role' | transloco
                              }}"
                            >
                              gavel
                            </mat-icon>
                          }
                          @case (RoomRole.Editor) {
                            <mat-icon
                              mat-list-icon
                              matTooltip="{{
                                'room-list.editor-role' | transloco
                              }}"
                              title="{{ 'room-list.editor-role' | transloco }}"
                            >
                              edit
                            </mat-icon>
                          }
                        }
                      </div>
                    </div>
                  </div>
                  <div fxLayout="row" fxLayoutAlign="center center">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="$event.stopPropagation()"
                      [matMenuTriggerFor]="moreActions"
                      aria-labelledby="more-options"
                      matTooltip="{{ 'room-list.more-options' | transloco }}"
                    >
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #moreActions="matMenu" xPosition="before">
                      @if (
                        [RoomRole.Owner, RoomRole.Editor].includes(
                          roomWithRole.role
                        )
                      ) {
                        <button
                          mat-menu-item
                          (click)="navToSettings(roomWithRole.room.shortId)"
                        >
                          <mat-icon>settings</mat-icon>
                          <span>
                            {{ 'room-list.room-settings' | transloco }}</span
                          >
                        </button>
                      }
                      @if (roomWithRole.role === RoomRole.Owner) {
                        <button
                          mat-menu-item
                          (click)="
                            duplicateRoom(
                              roomWithRole.room.id,
                              roomWithRole.room.name
                            )
                          "
                        >
                          <mat-icon>dynamic_feed</mat-icon>
                          <span>
                            {{ 'room-list.duplicate-room' | transloco }}</span
                          >
                        </button>
                      }
                      <button
                        mat-menu-item
                        (click)="openDeleteRoomDialog(roomWithRole)"
                      >
                        <mat-icon color="warn">delete_forever</mat-icon>
                        <span>
                          {{
                            (roomWithRole.role !== RoomRole.Owner
                              ? 'room-list.panel-remove-room'
                              : 'room-list.panel-delete-room'
                            ) | transloco
                          }}</span
                        >
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </button>
            }
          </mat-action-list>
          <button mat-flat-button (click)="fetchMore()" [hidden]="!hasMore()">
            {{ 'Load more' | transloco }}
          </button>
        }
      }
    </mat-card>
  </div>
</div>

<div class="visually-hidden">
  <div id="filter-rooms">{{ 'room-list.filter' | transloco }}</div>
  <div id="more-options">{{ 'room-list.a11y-more-options' | transloco }}</div>
</div>
